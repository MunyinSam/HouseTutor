generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id      String   @id @default(cuid())
  email   String   @unique
  name    String?
  decks   Deck[]
  reviews Review[]

  @@map("users")
}

model Deck {
  id              Int              @id @default(autoincrement())
  title           String           @unique
  description     String?
  category        String
  ownerId         String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime?        @updatedAt
  owner           User             @relation(fields: [ownerId], references: [id])
  questions       Question[]
  public          Boolean          @default(false)
  imageOcclusions ImageOcclusion[]

  @@map("decks")
}

model Question {
  id           Int        @id @default(autoincrement())
  front        String
  back         String
  parentId     Int?
  deckId       Int
  updatedAt    DateTime?
  flashcard    Flashcard?
  deck         Deck       @relation(fields: [deckId], references: [id], onDelete: Cascade)
  parent       Question?  @relation("SubQuestions", fields: [parentId], references: [id], onDelete: Cascade)
  subQuestions Question[] @relation("SubQuestions")
  imagePath    String?
  explanation  String?

  @@index([deckId])
  @@map("questions")
}

model Flashcard {
  id         Int      @id @default(autoincrement())
  questionId Int      @unique
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reviews    Review[]

  @@map("flashcards")
}

model Review {
  id                 Int       @id @default(autoincrement())
  userId             String
  flashcardId        Int
  easinessFactor     Float     @default(2.5)
  interval           Int       @default(0)
  consecutiveCorrect Int       @default(0)
  nextReviewDate     DateTime  @default(now())
  lastReviewedAt     DateTime  @default(now())
  flashcard          Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id])

  @@unique([userId, flashcardId])
  @@map("reviews")
}

model ImageOcclusion {
  id         Int       @id @default(autoincrement())
  deckId     Int
  deck       Deck      @relation(fields: [deckId], references: [id], onDelete: Cascade)
  title      String?
  imagePath  String
  occlusions Json      // Array of {id, x, y, width, height, label, answer}
  mode       String    @default("all") // "all" = reveal all at once, "one" = one by one
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([deckId])
  @@map("image_occlusions")
}
